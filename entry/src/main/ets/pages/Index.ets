import { promptAction } from '@kit.ArkUI';
import dataPreferences from '@ohos.data.preferences';

// æ·»åŠ ä»»åŠ¡åˆ†ç±»æšä¸¾
enum TaskCategory {
  All = "å…¨éƒ¨",
  Study = 'å­¦ä¹ ',
  Work = 'å·¥ä½œ',
  Life = 'ç”Ÿæ´»',
  Other = 'å…¶ä»–',
}

// æ·»åŠ ä»»åŠ¡ä¼˜å…ˆçº§æšä¸¾
enum TaskPriority {
  High = 'é«˜',
  Medium = 'ä¸­',
  Low = 'ä½'
}

// æ·»åŠ ä¸€ä¸ªè·å–æ‰€æœ‰åˆ†ç±»çš„æ–¹æ³•
const getAllCategories = (): TaskCategory[] => {
  return [
    TaskCategory.All,
    TaskCategory.Study,
    TaskCategory.Work,
    TaskCategory.Life,
    TaskCategory.Other,
  ];
}

// æ·»åŠ åˆ†ç±»æ—¶é—´é…ç½®æ¥å£
interface CategoryTimeConfig {
  workTime: number; // å·¥ä½œæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  breakTime: number; // ä¼‘æ¯æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
}

// æ·»åŠ åˆ†ç±»æ—¶é—´é…ç½®
const categoryTimeConfigs: Record<TaskCategory, CategoryTimeConfig> = {
  [TaskCategory.All]: { workTime: 25, breakTime: 5 },
  [TaskCategory.Study]: { workTime: 45, breakTime: 10 }, // å­¦ä¹ æ—¶é—´æ›´é•¿
  [TaskCategory.Work]: { workTime: 25, breakTime: 5 }, // æ ‡å‡†ç•ªèŒ„æ—¶é—´
  [TaskCategory.Life]: { workTime: 15, breakTime: 5 }, // ç”Ÿæ´»ä»»åŠ¡æ—¶é—´è¾ƒçŸ­
  [TaskCategory.Other]: { workTime: 20, breakTime: 5 }, // å…¶ä»–ä»»åŠ¡é€‚ä¸­
}

// ä¿®æ”¹ä»»åŠ¡æ¥å£ï¼Œæ·»åŠ categoryå­—æ®µ
interface Task {
  id: number;
  title: string;
  completed: boolean;
  pomodoros: number;
  todayPomodoros: number;
  lastPomodoroDate: string;
  category: TaskCategory; // æ–°å¢å­—æ®µ
  priority: TaskPriority; // æ–°å¢å­—æ®µ
}

// æ·»åŠ ä¸»é¢˜é¢œè‰²æ¥å£
interface ThemeColors {
  primary: string;
  secondary: string;
  background: string;
  selectedBackground: string;
  cardBg: string;
  textPrimary: string;
  textSecondary: string;
}

@Entry
@Component
struct Index {
  @State selectedCategory: TaskCategory = TaskCategory.All; // æ˜¾ç¤ºå½“å‰ç±»åˆ«
  @State addCategory: TaskCategory = TaskCategory.Work; // æ–°å¢å½“å‰ç±»åˆ«
  @State selectedPriority: TaskPriority = TaskPriority.Medium; // æ–°å¢çŠ¶æ€
  @State remainingTime: number = categoryTimeConfigs[this.selectedCategory].workTime * 60;
  @State isRunning: boolean = false;
  @State isWorkTime: boolean = true;
  @State tasks: Task[] = [];
  @State newTask: string = '';
  @State currentTaskId: number = -1;
  @State totalPomodoros: number = 0;
  @State todayPomodoros: number = 0;
  @State showAddTask: boolean = false;
  @State todayDate: string = new Date().toDateString();
  @State refreshFlag: number = 0;
  private timer: number = 0;
  private preferences: dataPreferences.Preferences | null = null;
  // æ·»åŠ  dialogController
  dialogController: CustomDialogController = new CustomDialogController({
    builder: this.DialogBuilder,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: -20 },
    customStyle: true,
    autoCancel: true,
    cancel: () => {
      this.showAddTask = false;
    }
  });
  // æ·»åŠ åˆ é™¤å¯¹è¯æ¡†æ§åˆ¶å™¨
  deleteDialogController: CustomDialogController = new CustomDialogController({
    builder: this.DeleteDialogBuilder,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: -20 },
    customStyle: true,
    autoCancel: true
  });
  // å½“å‰è¦åˆ é™¤çš„ä»»åŠ¡ID
  @State taskToDelete: Task | null = null;

  // å®šä¹‰å¯¹è¯æ¡†å†…å®¹æ„å»ºå™¨
  @Builder
  DialogBuilder() {
    Column() {
      Text('æ·»åŠ ä»»åŠ¡')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 16, bottom: 16 })

      TextInput({ placeholder: 'è¾“å…¥ä»»åŠ¡åç§°' })
        .width('90%')
        .height(50)
        .margin({ top: 8 })
        .onChange((value: string) => {
          this.newTask = value;
        })

      // æ·»åŠ åˆ†ç±»é€‰æ‹©
      Select([
        { value: TaskCategory.Work },
        { value: TaskCategory.Study },
        { value: TaskCategory.Life },
        { value: TaskCategory.Other }
      ])// .selected(0)
        .value(this.addCategory)
        .width('90%')
        .selectedOptionBgColor(this.themeColors.selectedBackground)
        .selectedOptionFontColor(this.themeColors.textPrimary)
        .margin({ top: 16 })
        .onSelect((index, value) => {
          this.addCategory = value as TaskCategory;
          this.currentTaskId = -1
        })

      // æ·»åŠ ä¼˜å…ˆçº§é€‰æ‹©
      Select([
        { value: TaskPriority.High },
        { value: TaskPriority.Medium },
        { value: TaskPriority.Low }
      ])
        .selected(1)// é»˜è®¤é€‰ä¸­ä¸­ç­‰ä¼˜å…ˆçº§
        .value(TaskPriority.Medium)
        .width('90%')
        .selectedOptionBgColor(this.themeColors.selectedBackground)
        .selectedOptionFontColor(this.themeColors.textPrimary)
        .margin({ top: 8 })
        .onSelect((index, value) => {
          this.selectedPriority = value as TaskPriority;
        })

      Row() {
        Button('å–æ¶ˆ')
          .width('40%')
          .height(40)
          .backgroundColor(this.themeColors.textSecondary)
          .margin({ top: 20, right: 8 })
          .onClick(() => {
            this.dialogController.close();
            this.showAddTask = false;
          })

        Button('æ·»åŠ ')
          .width('40%')
          .height(40)
          .backgroundColor(this.themeColors.primary)
          .margin({ top: 20, left: 8 })
          .onClick(() => {
            if (this.newTask.trim()) {
              // æ£€æŸ¥ä»»åŠ¡åç§°æ˜¯å¦é‡å¤
              if (this.isTaskNameDuplicate(this.newTask.trim())) {
                promptAction.showToast({
                  message: 'ä»»åŠ¡åç§°å·²å­˜åœ¨',
                  duration: 2000,
                });
                return;
              }
              this.createTask(this.newTask);
              this.newTask = '';
              this.dialogController.close();
              this.showAddTask = false;
            }
          })
      }
      .width('90%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('90%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(24)
  }

  // å®šä¹‰åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†å†…å®¹
  @Builder
  DeleteDialogBuilder() {
    Column() {
      Text('ç¡®è®¤åˆ é™¤')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 16, bottom: 16 })

      Text(this.taskToDelete ? `æ˜¯å¦åˆ é™¤ä»»åŠ¡"${this.taskToDelete.title}"ï¼Ÿ` : '')
        .fontSize(16)
        .fontColor(this.themeColors.textSecondary)
        .margin({ bottom: 20 })
        .textAlign(TextAlign.Center)

      Row() {
        Button('å–æ¶ˆ')
          .width('40%')
          .height(40)
          .backgroundColor(this.themeColors.textSecondary)
          .margin({ top: 20, right: 8 })
          .onClick(() => {
            this.deleteDialogController.close();
            this.taskToDelete = null;
          })

        Button('åˆ é™¤')
          .width('40%')
          .height(40)
          .backgroundColor(this.themeColors.primary)
          .margin({ top: 20, left: 8 })
          .onClick(() => {
            if (this.taskToDelete) {
              this.deleteTask(this.taskToDelete);
            }
            this.deleteDialogController.close();
            this.taskToDelete = null;
          })
      }
      .width('90%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('90%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(24)
  }

  // æ·»åŠ æ£€æŸ¥ä»»åŠ¡åç§°æ˜¯å¦é‡å¤çš„æ–¹æ³•
  private isTaskNameDuplicate(taskName: string): boolean {
    return this.tasks.some(task => task.title.toLowerCase() === taskName.toLowerCase());
  }

  async aboutToAppear() {
    try {
      // è·å–preferenceså®ä¾‹
      const context = getContext(this);
      this.preferences = await dataPreferences.getPreferences(context, 'PomodoroData');

      // åŠ è½½ä¿å­˜çš„æ•°æ®
      const tasksStr = await this.preferences.get('tasks', '[]');
      this.tasks = JSON.parse(tasksStr as string);
      this.totalPomodoros = await this.preferences.get('totalPomodoros', 0) as number;

      // åˆå§‹åŒ–ä»Šæ—¥æ€»ç•ªèŒ„æ•°
      this.updateTodayTotal();
    } catch (error) {
      console.error('Failed to load data:', error);
    }
  }

  // æ·»åŠ ä¿å­˜æ•°æ®çš„æ–¹æ³•
  private async saveData() {
    if (this.preferences) {
      try {
        await this.preferences.put('tasks', JSON.stringify(this.tasks));
        await this.preferences.put('totalPomodoros', this.totalPomodoros);
        await this.preferences.flush();
      } catch (error) {
        console.error('Failed to save data:', error);
      }
    }
  }

  // ä¿®æ”¹ä¸»é¢˜é¢œè‰²å®šä¹‰ï¼Œæ·»åŠ ç±»å‹å£°æ˜
  readonly themeColors: ThemeColors = {
    primary: '#FF6B6B', // ç•ªèŒ„çº¢
    secondary: '#4ECDC4', // æ¸…æ–°é’
    background: '#F7F7F7', // æµ…ç°èƒŒæ™¯
    selectedBackground: '#FFE8E8', // æµ…çº¢èƒŒæ™¯
    cardBg: '#FFFFFF', // å¡ç‰‡èƒŒæ™¯
    textPrimary: '#2D3436', // ä¸»è¦æ–‡å­—
    textSecondary: '#636E72'// æ¬¡è¦æ–‡å­—
  }

  // è·å–å½“å‰ä»»åŠ¡çš„æ—¶é—´é…ç½®
  private getCurrentTaskTimeConfig(): CategoryTimeConfig {
    // if (this.currentTaskId === -1) {
    //   return categoryTimeConfigs[TaskCategory.All]; // é»˜è®¤ä½¿ç”¨å·¥ä½œé…ç½®
    // }
    const currentTask = this.tasks.find(task => task.id === this.currentTaskId);
    if (currentTask) {
      return categoryTimeConfigs[currentTask.category];
    }
    if (this.selectedCategory) {
      return categoryTimeConfigs[this.selectedCategory]
    }
    return categoryTimeConfigs[TaskCategory.Work];
  }

  @Builder
  TimerSection() {
    Column() {
      Stack() {
        // èƒŒæ™¯åœ†ç¯
        Circle()
          .width(200)
          .height(200)
          .fill(this.themeColors.cardBg)
          .stroke(this.themeColors.background)
          .strokeWidth(8)
          .opacity(0.8)

        // è¿›åº¦åœ†ç¯
        Progress({
          value: this.remainingTime,
          total: this.isWorkTime ?
            this.getCurrentTaskTimeConfig().workTime * 60 :
            this.getCurrentTaskTimeConfig().breakTime * 60,
          type: ProgressType.Ring
        })
          .width(210)
          .height(210)
          .color(this.themeColors.primary)
          .style({
            strokeWidth: 8
          })

        Column() {
          Text(this.formatTime(this.remainingTime))
            .fontSize(64)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.themeColors.primary)

          Stack() { // ä½¿ç”¨Stackæ¥å®ç°æ—¶é—´æ–‡æœ¬çš„äº¤æ›¿åŠ¨ç”»
            Text('ä¸“æ³¨æ—¶é—´')
              .fontSize(20)
              .fontColor(this.themeColors.textSecondary)
              .opacity(this.isWorkTime ? 1 : 0)
              .animation({
                duration: 300,
                curve: Curve.EaseInOut
              })

            Text('ä¼‘æ¯æ—¶é—´')
              .fontSize(20)
              .fontColor(this.themeColors.textSecondary)
              .opacity(this.isWorkTime ? 0 : 1)
              .animation({
                duration: 300,
                curve: Curve.EaseInOut
              })
          }
          .margin({ top: 8 })
          .height(24) // å›ºå®šé«˜åº¦é¿å…åˆ‡æ¢æ—¶çš„æŠ–åŠ¨

          Row() {
            Text(`${this.getCurrentTaskTimeConfig().workTime}åˆ†é’Ÿ`)
              .fontSize(14)
              .fontColor(this.isWorkTime ? this.themeColors.primary : this.themeColors.textSecondary)
              .opacity(this.isWorkTime ? 1 : 0.6)
              .animation({
                duration: 300,
                curve: Curve.EaseInOut
              })

            Text(' / ')
              .fontSize(14)
              .fontColor(this.themeColors.textSecondary)

            Text(`${this.getCurrentTaskTimeConfig().breakTime}åˆ†é’Ÿ`)
              .fontSize(14)
              .fontColor(!this.isWorkTime ? this.themeColors.primary : this.themeColors.textSecondary)
              .opacity(!this.isWorkTime ? 1 : 0.6)
              .animation({
                duration: 300,
                curve: Curve.EaseInOut
              })
          }
          .margin({ top: 10 })
        }
      }
      .margin({ top: 5, bottom: 20 })
      .animation({
        duration: 1000,
        curve: Curve.EaseInOut
      })

      Row() {
        Button(this.isRunning ? 'æš‚åœ' : 'å¼€å§‹')
          .width(140)
          .height(48)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .backgroundColor(this.isRunning ? this.themeColors.secondary : this.themeColors.primary)
          .borderRadius(24)
          .onClick(() => this.toggleTimer())

        Button('é‡ç½®')
          .width(140)
          .height(48)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .backgroundColor(this.themeColors.textSecondary)
          .borderRadius(24)
          .margin({ left: 16 })
          .onClick(() => this.resetTimer())
      }
      .margin({ bottom: 10 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(this.themeColors.cardBg)
    .borderRadius(32)
    .margin({ top: 35 })
  }

  @Builder
  TaskSection() {
    Column() {
      // æ·»åŠ åˆ†ç±»ç­›é€‰å’Œæ–°å¢ä»»åŠ¡æŒ‰é’®
      Row() {
        // åˆ†ç±»ç­›é€‰
        Scroll() {
          Row() {
            ForEach(getAllCategories(), (category: TaskCategory) => {
              Text(category)
                .fontSize(14)
                .fontColor(this.selectedCategory === category ?
                this.themeColors.primary : this.themeColors.textSecondary)
                .backgroundColor(this.selectedCategory === category ?
                this.themeColors.selectedBackground : 'transparent')
                .padding(8)
                .borderRadius(16)
                .margin({ right: 8 })
                .onClick(() => {
                  this.selectedCategory = category;
                  this.resetTimer();
                })
            })
          }
          .width('100%')
          .padding({ left: 5, right: 16 })
        }
        .scrollable(ScrollDirection.Horizontal)
        .scrollBar(BarState.Off)
        .layoutWeight(1)

        // æ–°å¢ä»»åŠ¡æŒ‰é’®
        Button('+')
          .width(45)
          .height(30)
          .fontSize(24)
          .fontWeight(FontWeight.Medium)
          .backgroundColor(this.themeColors.primary)
          .borderRadius(20)
          .margin({ right: 5 })
          .onClick(() => {
            this.showAddTask = true;
            this.dialogController.open();
          })
      }
      .width('100%')
      .margin({ top: 8, bottom: 8 })

      List() {
        ForEach(this.getSortedTasks(), (task: Task) => {
          ListItem() {
            this.TaskItem(task)
          }
          .width('100%')
          .padding(8)
          .backgroundColor(this.currentTaskId === task.id ? this.themeColors.selectedBackground :
          this.themeColors.cardBg)
          .borderRadius(10)
          .opacity(task.completed ? 0.7 : 1)
          .shadow({
            radius: 8,
            color: '#00000010',
            offsetY: 2
          })
          .margin({ bottom: 8 })
          .onClick(() => this.selectTask(task))
          .swipeAction({ end: this.DeleteButton(task) })
        })
      }
      .width('100%')
      .height('30%')
      .padding({ left: 5, right: 5 })
      .scrollBar(BarState.Auto)

      Row() {
        Text(`ä»Šæ—¥å®Œæˆï¼š${this.todayPomodoros} ğŸ…`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.themeColors.primary)

        Blank()

        Text(`æ€»è®¡å®Œæˆï¼š${this.totalPomodoros} ğŸ…`)
          .fontSize(20)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.themeColors.textSecondary)
      }
      .width('100%')
      .padding({
        left: 16,
        right: 16,
        top: 12,
        bottom: 12
      })
      .backgroundColor(this.themeColors.cardBg)
      .borderRadius(16)
      .margin({ top: 16 })
    }
  }

  // æ·»åŠ åˆ é™¤æŒ‰é’®æ„å»ºå™¨
  @Builder
  DeleteButton(task: Task) {
    Button() {
      Text('åˆ é™¤')
        .fontSize(16)
        .fontColor(Color.White)
    }
    .width(80)
    .height('100%')
    .backgroundColor(Color.Red)
    .onClick(() => {
      this.showDeleteConfirm(task);
    })
  }

  // ä¿®æ”¹æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ–¹æ³•
  private showDeleteConfirm(task: Task) {
    this.taskToDelete = task;
    this.deleteDialogController.open();
  }

  // æ·»åŠ åˆ é™¤ä»»åŠ¡æ–¹æ³•
  private async deleteTask(delTask: Task) {
    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ä»»åŠ¡ï¼Œæ¸…é™¤é€‰ä¸­çŠ¶æ€
    if (delTask.id === this.currentTaskId) {
      this.currentTaskId = -1;
    }

    // åˆ›å»ºæ–°çš„ä»»åŠ¡æ•°ç»„ï¼Œæ’é™¤è¦åˆ é™¤çš„ä»»åŠ¡
    const newTasks: Task[] = [];
    for (const task of this.tasks) {
      if (task.id !== delTask.id) {
        newTasks.push(task);
      }
    }

    // æ›´æ–°ä»»åŠ¡åˆ—è¡¨
    this.tasks = newTasks;

    // æ›´æ–°ä»Šæ—¥æ€»ç•ªèŒ„æ•°
    this.updateTodayTotal();

    // ä¿å­˜æ›´æ”¹
    await this.saveData();

    // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
    promptAction.showToast({
      message: 'ä»»åŠ¡ ' + delTask.title + ' å·²åˆ é™¤',
      duration: 2000,
    });
  }

  build() {
    Column() {
      this.TimerSection()
      this.TaskSection()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.themeColors.background)
    .padding(16)
  }

  private formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  private toggleTimer() {
    if (this.isRunning) {
      clearInterval(this.timer);
    } else {
      this.timer = setInterval(async () => {
        if (this.remainingTime > 0) {
          this.remainingTime--;
        } else {
          await this.completePomodoro();
        }
      }, 1000);
    }
    this.isRunning = !this.isRunning;
  }

  private resetTimer() {
    clearInterval(this.timer);
    this.isRunning = false;
    const timeConfig = this.getCurrentTaskTimeConfig();
    this.remainingTime = this.isWorkTime ?
      timeConfig.workTime * 60 : timeConfig.breakTime * 60;
  }

  private async completePomodoro() {
    if (this.isWorkTime) {
      this.totalPomodoros++;

      if (this.currentTaskId !== -1) {
        const taskIndex = this.tasks.findIndex(t => t.id === this.currentTaskId);
        if (taskIndex !== -1) {
          // åˆ›å»ºæ–°çš„ä»»åŠ¡æ•°ç»„å¹¶æ›´æ–°ä»»åŠ¡
          const newTasks: Task[] = [];
          for (let i = 0; i < this.tasks.length; i++) {
            if (i === taskIndex) {
              const today = new Date().toDateString();
              newTasks.push({
                id: this.tasks[i].id,
                title: this.tasks[i].title,
                completed: this.tasks[i].completed,
                pomodoros: this.tasks[i].pomodoros + 1,
                todayPomodoros: this.tasks[i].lastPomodoroDate === today ?
                  this.tasks[i].todayPomodoros + 1 : 1,
                lastPomodoroDate: today,
                category: this.tasks[i].category,
                priority: this.tasks[i].priority
              });
            } else {
              newTasks.push(this.tasks[i]);
            }
          }

          // æ›´æ–°ä»»åŠ¡æ•°ç»„
          this.tasks = newTasks;

          // ç«‹å³æ›´æ–°ä»Šæ—¥æ€»ç•ªèŒ„æ•°
          this.updateTodayTotal();
        }
      }

      await this.saveData();

      promptAction.showToast({
        message: 'å¤ªæ£’äº†ï¼å®Œæˆäº†ä¸€ä¸ªğŸ…ï¼',
        duration: 2000,
      });
    }
    this.switchMode();
  }

  // æ›´æ–°ä»Šæ—¥æ€»ç•ªèŒ„æ•°
  private updateTodayTotal() {
    const today = new Date().toDateString();
    let total = 0;
    for (const task of this.tasks) {
      if (task.lastPomodoroDate === today) {
        total += task.todayPomodoros;
      }
    }
    this.todayPomodoros = total;
  }

  private switchMode() {
    this.isWorkTime = !this.isWorkTime;
    const timeConfig = this.getCurrentTaskTimeConfig();
    this.remainingTime = this.isWorkTime ?
      timeConfig.workTime * 60 : timeConfig.breakTime * 60;
    this.resetTimer();
  }

  private selectTask(task: Task) {
    if (task.completed) {
      promptAction.showToast({
        message: 'ä»»åŠ¡å·²å®Œæˆ',
        duration: 2000,
      })
      return
    }
    if (this.currentTaskId === task.id) {
      this.currentTaskId = -1
    } else {
      this.currentTaskId = task.id;
    }
    // é€‰æ‹©æ–°ä»»åŠ¡æ—¶é‡ç½®è®¡æ—¶å™¨
    this.resetTimer();
  }

  private async createTask(title: string) {
    // æ·»åŠ è¾“å…¥éªŒè¯
    if (!title || title.trim().length === 0) {
      promptAction.showToast({
        message: 'ä»»åŠ¡åç§°ä¸èƒ½ä¸ºç©º',
        duration: 2000,
      });
      return;
    }
    if (title.length > 20) {
      promptAction.showToast({
        message: 'ä»»åŠ¡åç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦',
        duration: 2000,
      });
      return;
    }

    const newTask: Task = {
      id: Date.now(),
      title: title,
      completed: false,
      pomodoros: 0,
      todayPomodoros: 0,
      lastPomodoroDate: new Date().toDateString(),
      category: this.addCategory,
      priority: this.selectedPriority || TaskPriority.Medium
    };

    // åˆ›å»ºæ–°æ•°ç»„å¹¶æ·»åŠ ä»»åŠ¡
    const newTasks: Task[] = [];
    for (const task of this.tasks) {
      newTasks.push(task);
    }
    newTasks.push(newTask);

    this.tasks = newTasks;
    await this.saveData();
  }

  aboutToDisappear() {
    clearInterval(this.timer);
    if (this.preferences) {
      this.preferences.flush();
    }
  }

  // æ·»åŠ åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€çš„æ–¹æ³•
  private async toggleTaskComplete(taskId: number, completed: boolean) {
    const newTasks: Task[] = [];
    for (const task of this.tasks) {
      if (task.id === taskId) {
        newTasks.push({
          id: task.id,
          title: task.title,
          completed: completed,
          pomodoros: task.pomodoros,
          todayPomodoros: task.todayPomodoros,
          lastPomodoroDate: task.lastPomodoroDate,
          category: task.category,
          priority: task.priority
        });
        this.currentTaskId = -1
      } else {
        newTasks.push(task);
      }
    }
    this.tasks = newTasks;
    await this.saveData();
  }

  // æ·»åŠ ä»»åŠ¡ç­›é€‰æ–¹æ³•
  private getFilteredTasks(): Task[] {
    if (this.selectedCategory === TaskCategory.All) {
      return this.tasks;
    }
    const filteredTasks: Task[] = [];
    for (const task of this.tasks) {
      if (task.category === this.selectedCategory) {
        filteredTasks.push(task);
      }
    }
    return filteredTasks;
  }

  // è·å–ä¼˜å…ˆçº§é¡ºåºå€¼
  private getPriorityValue(priority: TaskPriority): number {
    switch (priority) {
      case TaskPriority.High:
        return 0;
      case TaskPriority.Medium:
        return 1;
      case TaskPriority.Low:
        return 2;
      default:
        return 1;
    }
  }

  // ä¿®æ”¹ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤ºï¼Œä¼˜åŒ–å¸ƒå±€å¹¶æ’åºä»»åŠ¡
  private getSortedTasks(): Task[] {
    const filteredTasks = this.getFilteredTasks();
    return filteredTasks.sort((a, b) => {
      // å·²å®Œæˆçš„ä»»åŠ¡æ’åœ¨æœ€å
      if (a.completed !== b.completed) {
        return a.completed ? 1 : -1;
      }
      // æœªå®Œæˆçš„ä»»åŠ¡æŒ‰ä¼˜å…ˆçº§æ’åº
      if (!a.completed) {
        return this.getPriorityValue(a.priority) - this.getPriorityValue(b.priority);
      }
      return 0;
    });
  }

  // è·å–ä¼˜å…ˆçº§å¯¹åº”çš„é¢œè‰²
  private getPriorityColor(priority: TaskPriority): string {
    switch (priority) {
      case TaskPriority.High:
        return '#FF4949';
      case TaskPriority.Medium:
        return '#FFA940';
      case TaskPriority.Low:
        return '#52C41A';
      default:
        return '#FFA940';
    }
  }

  // è·å–ä¼˜å…ˆçº§å¯¹åº”çš„èƒŒæ™¯è‰²
  private getPriorityBgColor(priority: TaskPriority): string {
    switch (priority) {
      case TaskPriority.High:
        return '#FFE8E8';
      case TaskPriority.Medium:
        return '#FFF7E6';
      case TaskPriority.Low:
        return '#F6FFED';
      default:
        return '#FFF7E6';
    }
  }

  // ä¿®æ”¹ä»»åŠ¡é¡¹æ˜¾ç¤º
  @Builder
  TaskItem(task: Task) {
    Row() {
      Toggle({ type: ToggleType.Checkbox, isOn: task.completed })
        .onChange((isOn) => {
          this.toggleTaskComplete(task.id, isOn);
        })
        .margin({ right: 8 })

      Column() {
        Row() {
          Column() { // å·¦ä¾§å†…å®¹
            Row() { // ç¬¬ä¸€æ’
              Text(task.priority)
                .fontSize(16)
                .fontColor(this.getPriorityColor(task.priority))
                .backgroundColor(this.getPriorityBgColor(task.priority))
                .padding({
                  left: 6,
                  right: 16,
                  top: 2,
                  bottom: 2
                })
                .borderRadius(10)
                .margin({ right: 8 })

              Text(task.category)
                .fontSize(16)
                .fontColor(this.themeColors.primary)
                .backgroundColor(this.themeColors.selectedBackground)
                .padding({
                  left: 8,
                  right: 8,
                  top: 2,
                  bottom: 2
                })
                .borderRadius(12)
                .margin({ right: 12 })
                .visibility(this.selectedCategory === TaskCategory.All ? Visibility.Visible : Visibility.None)

              Text(task.title)
                .fontSize(20)
                .fontWeight(FontWeight.Medium)
                .fontColor(this.themeColors.textPrimary)
                .decoration({
                  type: task.completed ? TextDecorationType.LineThrough : TextDecorationType.None,
                  color: this.themeColors.textSecondary
                })
            }

            Row() { // ç¬¬äºŒæ’
              Text(`ä»Šæ—¥ï¼š${task.todayPomodoros} ğŸ…`)
                .fontSize(14)
                .fontColor(this.themeColors.textSecondary)
                .margin({ right: 12 })

              Text(`æ€»è®¡ï¼š${task.pomodoros} ğŸ…`)
                .fontSize(14)
                .fontColor(this.themeColors.textSecondary)
            }
            .margin({ top: 4 })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

          if (this.currentTaskId === task.id) {
            Text('è¿›è¡Œä¸­')
              .fontColor(this.themeColors.primary)
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .margin({ left: 8 })
              .transition({
                type: TransitionType.All,
                opacity: 1,
                scale: { x: 1, y: 1 }
              })
              .animation({
                duration: 1000,
                tempo: 3.0,
                delay: 0,
                curve: Curve.Linear,
                playMode: PlayMode.Alternate,
                iterations: -1
              })
              .scale({ x: 1.1, y: 1.1 })
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .layoutWeight(1)
    }
  }
}